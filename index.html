<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Code Validator</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; background:#f4f4f9; }
    #reader { width: 320px; margin: 20px auto; }
    .card { 
      display: none; max-width: 400px; margin: 20px auto; 
      padding: 15px; border-radius: 12px; 
      background: white; box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      text-align: left;
    }
    .row { display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #eee; }
    .row:last-child{ border-bottom:none; }
    .key { font-weight:bold; color:#555; }
    .val { color:#222; }
    .badge { display:inline-block; padding:4px 10px; border-radius:6px; font-size:0.9em; margin-bottom:10px; }
    .ok { background:#d4edda; color:#155724; }
    .bad { background:#f8d7da; color:#721c24; }
    .error { background:#fff3cd; color:#856404; }
    #clearBtn { margin-top:15px; padding:8px 15px; border:none; border-radius:8px; background:#007bff; color:white; font-size:1em; cursor:pointer; }
    #clearBtn:hover { background:#0056b3; }
  </style>
</head>
<body>
  <h2>QR Code Validator</h2>
  <div id="reader"></div>

  <div id="resultCard" class="card">
    <div id="statusBadge" class="badge"></div>
    <div id="statusText"></div>
    <div id="details"></div>
    <button id="clearBtn">Scan Again</button>
  </div>

  <div id="errorCard" class="card">
    <div class="badge error">Invalid QR</div>
    <div id="errorText"></div>
    <button id="clearBtn">Scan Again</button>
  </div>

  <script>
    let scanner;

    // Helper: format money if number-like
    function formatMoney(x){
      if (x===undefined || x===null || x==="") return "";
      const n = Number(x);
      if (Number.isNaN(n)) return x;
      return "â‚¹" + n.toLocaleString("en-IN", {maximumFractionDigits:0});
    }

    function renderDetails(obj){
      const fields = [
        ["Booking ID", obj.BookingID],
        ["Name", obj.Name],
        ["Contact", obj.Contact],
        ["Age", obj.Age],
        ["Gender", obj.Gender],
        ["Size", obj.Size],
        ["Paid", formatMoney(obj.Paid)],
        ["Due", formatMoney(obj.Due)],
        ["Total", formatMoney(obj.Total)],
        ["Confirmation", obj.Confirmation]
      ];
      return fields.map(([k,v])=>`
        <div class="row">
          <div class="key">${k}</div>
          <div class="val">${(v ?? "").toString()}</div>
        </div>
      `).join("");
    }

    function showResult(obj){
      document.getElementById("reader").style.display = "none";  // hide camera
      const resultCard = document.getElementById("resultCard");
      const statusBadge = document.getElementById("statusBadge");
      const statusText = document.getElementById("statusText");
      const details = document.getElementById("details");
      const errorCard = document.getElementById("errorCard");

      errorCard.style.display = "none";
      resultCard.style.display = "block";

      const due = Number(obj.Due||0);
      if (!Number.isNaN(due) && due>0){
        statusBadge.className = "badge bad";
        statusBadge.textContent = "Due Pending";
        statusText.textContent = `Payment due ${formatMoney(due)}`;
      } else {
        statusBadge.className = "badge ok";
        statusBadge.textContent = "Payment Clear";
        statusText.textContent = "All dues settled";
      }
      details.innerHTML = renderDetails(obj);

      if (navigator.vibrate) navigator.vibrate(50);

      // ðŸ”´ stop scanner
      if (scanner) {
        scanner.clear().catch(err => console.warn("Clear failed", err));
        scanner = null;
      }
    }

    function showError(msg){
      document.getElementById("reader").style.display = "none";
      document.getElementById("resultCard").style.display = "none";
      const e = document.getElementById("errorCard");
      document.getElementById("errorText").textContent = msg;
      e.style.display = "block";
      if (navigator.vibrate) navigator.vibrate([30, 40, 30]);
      if (scanner) {
        scanner.clear().catch(err => console.warn("Clear failed", err));
        scanner = null;
      }
    }

    function restartScanner(){
      document.getElementById("resultCard").style.display = "none";
      document.getElementById("errorCard").style.display = "none";
      document.getElementById("reader").style.display = "block";
      if (!scanner) {
        scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 }, false);
        scanner.render(onScanSuccess, onScanFailure);
      }
    }

    // Attach to all "Scan Again" buttons
    document.querySelectorAll("#clearBtn").forEach(btn => {
      btn.addEventListener("click", restartScanner);
    });

    function onScanSuccess(decodedText){
      try{
        const obj = JSON.parse(decodedText);
        if (!obj.BookingID) throw new Error("Missing BookingID");
        showResult(obj);
      }catch(e){
        showError("Could not parse QR content. Raw: " + decodedText);
      }
    }
    function onScanFailure(error){ /* ignore noisy frames */ }

    // Start scanner on load
    restartScanner();
  </script>
</body>
</html>
