<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sneh Prayas QR Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script type="module">
    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, deleteDoc, doc } 
      from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCqOM8xLXE6aIPvoP7NIjB70023g68PSdU",
      authDomain: "ashtapad-mahavandana-2025.firebaseapp.com",
      projectId: "ashtapad-mahavandana-2025",
      storageBucket: "ashtapad-mahavandana-2025.firebasestorage.app",
      messagingSenderId: "3610641543",
      appId: "1:3610641543:web:0ddf96d30f969638cde422",
      measurementId: "G-ER6BYGWZZL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const scansRef = collection(db, "scans");

    // Full passenger list
    const masterPassengers = [
      {BookingID:"SPC101",Amount:"35000",Name:"Sulekha Patni"},
      {BookingID:"SPC102",Amount:"35000",Name:"Abhay Patni"},
      {BookingID:"SPC103",Amount:"35000",Name:"Kathanshi Patni"},
      {BookingID:"SPC104",Amount:"35000",Name:"Maina Devi Patni"},
      {BookingID:"SPC105",Amount:"",Name:"Priyanka Barjatya"},
      {BookingID:"SPC106",Amount:"",Name:"Vinit Barjatya"},
      {BookingID:"SPC107",Amount:"",Name:"Hardik Barjatya"},
      {BookingID:"SPC108",Amount:"",Name:"Sanaya Barjatya"},
      {BookingID:"SPC109",Amount:"",Name:"Sonika Kala"},
      {BookingID:"SPC110",Amount:"",Name:"Arvind Kala"},
      {BookingID:"SPC111",Amount:"",Name:"Hansvi Kala"},
      {BookingID:"SPC112",Amount:"",Name:"Ridhish Kala"},
      {BookingID:"SPC113",Amount:"37100",Name:"Anita Patni"},
      {BookingID:"SPC114",Amount:"35000",Name:"Arun Patni"},
      {BookingID:"SPC115",Amount:"35000",Name:"Akshat Patni"},
      {BookingID:"SPC116",Amount:"35000",Name:"Ishika Patni"},
      {BookingID:"SPC117",Amount:"35000",Name:"Seema Pandya"},
      {BookingID:"SPC118",Amount:"35000",Name:"Maina Devi Pandya"},
      {BookingID:"SPC119",Amount:"35000",Name:"Dashna Pandya"},
      {BookingID:"SPC120",Amount:"35000",Name:"Diva Pandya"},
      {BookingID:"SPC121",Amount:"45000",Name:"Sunita Barjatya"},
      {BookingID:"SPC122",Amount:"45000",Name:"Aklank Barjatya"},
      {BookingID:"SPC125",Amount:"11000",Name:"Bina Barjatya"},
      {BookingID:"SPC126",Amount:"11000",Name:"Vishal Barjatya"},
      {BookingID:"SPC127",Amount:"11000",Name:"Yogita Barjatya"},
      {BookingID:"SPC128",Amount:"11000",Name:"Lalita Barjatya"},
      {BookingID:"SPC129",Amount:"35000",Name:"Geeta Jain"},
      {BookingID:"SPC130",Amount:"35000",Name:"Dipika Patni"},
      {BookingID:"SPC131",Amount:"35000",Name:"Anil Patni"},
      {BookingID:"SPC132",Amount:"35000",Name:"Grishi Patni"},
      {BookingID:"SPC133",Amount:"35000",Name:"Meena Patni"},
      {BookingID:"SPC134",Amount:"35000",Name:"Devendra Patni"},
      {BookingID:"SPC135",Amount:"35000",Name:"Mehak Patni"},
      {BookingID:"SPC136",Amount:"35000",Name:"SWATI JAIN"},
      {BookingID:"SPC137",Amount:"35000",Name:"Neelam Rawka"},
      {BookingID:"SPC138",Amount:"24000",Name:"MAINA DEVI JAIN"},
      {BookingID:"SPC140",Amount:"35000",Name:"Rekha Sethi"},
      {BookingID:"SPC141",Amount:"35000",Name:"Alka Sogani"},
      {BookingID:"SPC142",Amount:"35000",Name:"Sweta Sogani"},
      {BookingID:"SPC143",Amount:"35000",Name:"Seema Patni"},
      {BookingID:"SPC144",Amount:"35000",Name:"Narendra Patni"},
      {BookingID:"SPC145",Amount:"24000",Name:"Sugandha Gangwal"},
      {BookingID:"SPC146",Amount:"24000",Name:"Vinit Gangwal"},
      {BookingID:"SPC147",Amount:"",Name:"Pushpa Gangwal"},
      {BookingID:"SPC148",Amount:"",Name:"Ridhi Gangwal"},
      {BookingID:"SPC149",Amount:"",Name:"Vijetha Kasliwal"},
      {BookingID:"SPC150",Amount:"",Name:"Tarun Kasliwal"}
    ];

    let html5QrCode;

    // Start scanner
    window.startScanner = function () {
      document.getElementById("reader").style.display = "block";
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        async (decodedText) => {
          try {
            const data = JSON.parse(decodedText);
            await addDoc(scansRef, data);
            html5QrCode.stop();
            document.getElementById("reader").style.display = "none";
          } catch {
            alert("Invalid QR Code!");
          }
        }
      );
    };

    // Show scanned details live
    const resultDiv = document.getElementById("result");
    const pendingDiv = document.getElementById("pending");

    onSnapshot(scansRef, (snapshot) => {
      const scanned = snapshot.docs.map(d => d.data());
      displayResults(scanned);
      showPending(scanned);
    });

    function displayResults(scanned) {
      resultDiv.innerHTML = "";
      scanned.forEach((data, index) => {
        resultDiv.innerHTML += `
          <div>
            <strong>${index + 1}. ${data.BookingID}</strong><br>
            Name: ${data.Name}<br>
            Amount: ${data.Amount || "-"}
          </div><hr>
        `;
      });
    }

    window.resetDetails = async function() {
      const snapshot = await getDocs(scansRef);
      snapshot.forEach(async (docSnap) => {
        await deleteDoc(doc(db, "scans", docSnap.id));
      });
    };

    function showPending(scanned) {
      const scannedIDs = scanned.map(s => s.BookingID);
      const pending = masterPassengers.filter(p => !scannedIDs.includes(p.BookingID));
      pendingDiv.innerHTML = "<h3>Pending Passengers:</h3>";
      pending.forEach(p => {
        pendingDiv.innerHTML += `<div>${p.BookingID} - ${p.Name} (${p.Amount || "-"})</div>`;
      });
    }
  </script>
  <style>
    body { font-family: 'Poppins', sans-serif; text-align: center; }
    #reader { width: 300px; margin: 20px auto; display: none; }
    #result, #pending { margin: 20px; text-align: left; }
    button { margin: 10px; padding: 10px 15px; }
  </style>
</head>
<body>
  <h1>ASHTAPAD MAHAVANDANA 2025</h1>
  <button onclick="startScanner()">Scan QR</button>
  <button onclick="resetDetails()">Reset All</button>
  <div id="reader"></div>
  <div id="result">Scanned results will appear here...</div>
  <div id="pending"></div>
</body>
</html>
